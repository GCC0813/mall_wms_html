<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>商品入库</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui/css/layui.css">
    <link rel="stylesheet" href="../css/goods.css">
</head>
<body>
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>商品详情和编辑</legend>
</fieldset>

<div class="layui-form" action="">
    <div class="layui-form-item">
        <label class="layui-form-label">商品名</label>
        <div class="layui-input-block">
            <input type="text" id="goods-name" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">商品主图</label>
        <div class="layui-input-block">
            <table><tr id="pic-img">
                <td id="goods-add-img-edit-container"><button title="添加商品主图" class="layui-btn layui-btn-primary add-img-edit" id="goods-add-img-edit">+</button></td>
            </tr></table>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">商品详情图</label>
            <div class="layui-input-inline">
                <table><tr id="detail-pic-img">
                    <td id="goods-add-detail-img-edit-container"><button title="添加商品详情图" class="layui-btn layui-btn-primary add-img-edit" id="goods-add-detail-img-edit">+</button></td>
                </tr></table>
            </div>
        </div>
    </div>

    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">商品简介</label>
        <div class="layui-input-block">
            <textarea class="layui-textarea" id="goods-synopsis"></textarea>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">商品分类</label>
            <div class="layui-input-inline">
                <select id="goods_category_select" lay-filter="check_on_tag">
                </select>
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">商品标签</label>
            <div class="layui-input-inline">
                <select  id="goods_tag_select" >
                </select>
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">市场参考价</label>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" id="market-price">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">采购价</label>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" id="purchase-price">
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">实物或虚拟</label>
            <div class="layui-input-inline">
                <select name="modules" lay-search="" id="physical-or-virtual">
                    <option value="0">虚拟</option>
                    <option value="1">实物</option>
                </select>
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">供应商</label>
            <div class="layui-input-inline">
                <select name="modules" lay-search="" id="goods-supplier">
                </select>
            </div>
        </div>
    </div>

   <!-- <div class="layui-form-item">
        <label class="layui-form-label">商品状态</label>
        <div class="layui-input-block">
            <input type="checkbox" name="close" lay-skin="switch" lay-text="上架|下架">
        </div>
    </div>-->

   <!-- <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">审核人</label>
            <div class="layui-input-inline">
                <input type="text" readonly class="layui-input" id="goods-toExamine-people">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">审核时间</label>
            <div class="layui-input-inline">
                <input type="text" readonly class="layui-input" id="goods-toExamine-time">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">创建人</label>
            <div class="layui-input-inline">
                <input type="text" readonly class="layui-input" id="goods-founder">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">创建时间</label>
            <div class="layui-input-inline">
                <input type="text" readonly class="layui-input" id="goods-founder-time">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">修改人</label>
            <div class="layui-input-inline">
                <input type="text" readonly class="layui-input" id="goods-modifier">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">修改时间</label>
            <div class="layui-input-inline">
                <input type="text" readonly class="layui-input" id="goods-modify-time">
            </div>
        </div>
    </div>-->

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button type="submit" class="layui-btn" onclick="add_goods_submit()">立即添加</button>
        </div>
    </div>
</div>

<script type="text/javascript" src="../../lib/layui/layui.js" ></script>
<script type="text/javascript" src="../../comm/jquery.js"></script>
<script type="text/javascript" src="../../comm/comm.js"></script>
<script type="text/javascript" src="../js/goods.js"></script>
<script type="text/javascript" src="../../comm/qiniu.min.js"></script>
<script type="text/javascript" src="../../comm/moxie.min.js"></script>
<script type="text/javascript" src="../../comm/plupload.full.min.js"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>
    layui.use([ 'layedit','jquery'], function(){
        $(function () {
            reading_add_goods();
            set_goods_supplier_select();
        });
    });

    function reading_add_goods() {
        $.post(domain+'/goods/goodsVarietyAdmin', function (res) {
            if (res.code===200){
                set_cate_tag_select(res.data.goodVrietyOut);
            }else {
                $("#cate-select-one").html('<option value="0">请选择商品类别</option>');
                $("#tag-select-two").html('<option value="0">请选择商品标签</option>');
            }
        });
    }

    function set_cate_tag_select(goodVrietyList) {
        let form = layui.form;
        let goodVriety = "";
        let goodVrietySelectStr = '';
        let goods_category_select = $("#goods_category_select");
        for (let i = 0, len = goodVrietyList.length; i < len; i++) {
            goodVriety = goodVrietyList[i];
            goodVrietySelectStr +="<option value='" + goodVriety.vrietyId + "'>" + goodVriety.vrietyName + "</option>"
        }
        goods_category_select.html(goodVrietySelectStr);

        let selectGoodVriety = goods_category_select.val();

        let goodTagsList="";
        for (let i in goodVrietyList){
            if(goodVrietyList[i].vrietyId === parseInt(selectGoodVriety)){
                goodTagsList = goodVrietyList[i].goodTagsList
            }
        }
        let goodTags = "";
        let goodTagsSelectStr = "";
        for (let i = 0; i < goodTagsList.length; i++) {
            goodTags = goodTagsList[i];
            goodTagsSelectStr += "<option value='" + goodTags.tagId + "'>" + goodTags.tagName + "</option>"
        }
        $("#goods_tag_select").html(goodTagsSelectStr);
        form.on('select(check_on_tag)', function(data){
            if(data.value > 0){
                let obj={
                    categoryId : data.value
                };
                $.post(domain+'/goods/details/get_tags_by_cate',objToJson(obj),function (resp) {
                    if (resp.code === 200) {
                        let goodTagsList = resp.data.rows;
                        let tag = "";
                        $.each(goodTagsList,function (index, data) {
                            tag += '<option value="'+data.tagId+'">'+data.tagName+'</option>';
                        });
                        $("#goods_tag_select").html(tag);
                    } else {
                        $("#goods_tag_select").html('<option value="0">请选择商品类别</option>');
                    }
                    form.render('select');
                });
            }else {
                $("#goods_tag_select").html('<option value="0">请选择商品标签</option>');
                form.render('select');
            }
        });
        form.render('select');
    }
    function set_goods_supplier_select() {
        let form = layui.form;
        let supplier = {
            type: 2
        };
        $.post(domain + '/goods/details/supplier', objToJson(supplier), function (resp) {
            if (resp.code === 200) {
                let supplierList = resp.data.rows;
                let supplier_select = '<option value="0">请选择供应商</option>';
                $.each(supplierList, function (index, supplier) {
                    supplier_select += '<option value="' + supplier.id + '">' + supplier.name + '</option>'
                });
                $("#goods-supplier").html(supplier_select);
            } else {
                $("#goods-supplier").html('<option value="0">请选择供应商</option>');
            }
            form.render('select');
        });
    }

    function add_goods_submit() {
        let good_name=$("#goods-name").val();
        let pic_img=$("#pic-img img");
        let detail_pic_img=$("#detail-pic-img img");
        let goods_synopsis=$("#goods-synopsis").val();
        let goods_category_select=$("#goods_category_select").val();
        let goods_tag_select=$("#goods_tag_select").val();
        let market_price=$("#market-price").val();
        let purchase_price=$("#purchase-price").val();
        let physical_or_virtual=$("#physical-or-virtual").val();
        let goods_supplier=$("#goods-supplier").val();
        if(good_name.length<1){
            layer.msg("请填写商品名！",{offset: '60px'});
            return;
        }
        if(pic_img.length===0 || detail_pic_img.length===0){
            layer.msg("请上传商品图！",{offset: '60px'});
            return;
        }
        if(goods_synopsis.length<1){
            layer.msg("请填写商品简介！",{offset: '60px'});
            return;
        }

        if(goods_category_select===0 || goods_tag_select===0){
            layer.msg("请选择分类或标签！",{offset: '60px'});
            return;
        }
        if(goods_supplier===0){
            layer.msg("请选择供应商！",{offset: '60px'});
            return;
        }
        if(market_price.length<1){
            layer.msg("请填写市场参考价！",{offset: '60px'});
            return;
        }
        if(purchase_price.length<1){
            layer.msg("请填写采购价！",{offset: '60px'});
            return;
        }

        let pic_img_src="";
        if(pic_img.length>1){
            for (let i=0;i<pic_img.length;i++){
                pic_img_src+=pic_img[i].src+",";
            }
        }else if(pic_img.length===1){
            pic_img_src=pic_img[0].src
        }
        let detail_pic_img_src="";
        if(detail_pic_img.length>1){
            for(let i=0;i<detail_pic_img.length;i++){
                detail_pic_img_src+=detail_pic_img[i].src+",";
            }
        }else if(detail_pic_img.length===1){
            detail_pic_img_src=detail_pic_img[0].src
        }
        let obj={
            categoryId:goods_category_select,
            tagId:goods_tag_select,
            isReal:physical_or_virtual,
            supplierId:goods_supplier,
            picUrls:pic_img_src,
            detailPicUrls:detail_pic_img_src
        };
        if(good_name.length>0){
            obj.name=good_name
        }
        if(goods_synopsis.length>0){
            obj.synopsis=goods_synopsis
        }
        if(market_price.length>0){
            obj.marketPrice=market_price;
        }
        if(purchase_price.length>0){
            obj.purchasePrice=purchase_price;
        }
        $.post(domain+'/goods/add',objToJson(obj),function (res) {
            if(res.code===200){
                layer.msg("增加商品成功！请继续添加。",function () {
                    location.reload()
                });
            }else if(res.code===102){
                layer.msg(res.msg,{icon:5,offset: '20px'},function () {
                    top.location='../login.html'
                })
            }else {
                layer.msg(res.msg)
            }
        });
    }

    Qiniu.uploader({
        runtimes: 'html5,flash,html4',      // 上传模式，依次退化
        browse_button: 'goods-add-img-edit',         // 上传选择的点选按钮，必需
        // 在初始化时，uptoken，uptoken_url，uptoken_func三个参数中必须有一个被设置
        // 切如果提供了多个，其优先级为uptoken > uptoken_url > uptoken_func
        // 其中uptoken是直接提供上传凭证，uptoken_url是提供了获取上传凭证的地址，如果需要定制获取uptoken的过程则可以设置uptoken_func
        //uptoken : domain+'/upload/getQiniuToken', // uptoken是上传凭证，由其他程序生成
        uptoken_url: domain + '/upload/getQiniuToken',// Ajax请求uptoken的Url，强烈建议设置（服务端提供）
        // uptoken_func: function(){    // 在需要获取uptoken时，该方法会被调用
        //    // do something
        //    return uptoken;
        // },
        get_new_uptoken: false,             // 设置上传文件的时候是否每次都重新获取新的uptoken
        // downtoken_url: '/downtoken',
        // Ajax请求downToken的Url，私有空间时使用，JS-SDK将向该地址POST文件的key和domain，服务端返回的JSON必须包含url字段，url值为该文件的下载地址
        //unique_names: true,              // 默认false，key为文件名。若开启该选项，JS-SDK会为每个文件自动生成key（文件名）
        // save_key: true,                  // 默认false。若在服务端生成uptoken的上传策略中指定了sava_key，则开启，SDK在前端将不对key进行任何处理
        domain: 'http://static.gcc666.top/',     // bucket域名，下载资源时用到，必需
        container: 'goods-add-img-edit-container',             // 上传区域DOM ID，默认是browser_button的父元素
        max_file_size: '100mb',             // 最大文件体积限制
        //flash_swf_url: 'path/of/plupload/Moxie.swf',  //引入flash，相对路径
        max_retries: 3,                     // 上传失败最大重试次数
        dragdrop: true,                     // 开启可拖曳上传
        drop_element: 'goods-add-img-edit-container',          // 拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
        chunk_size: '4mb',                  // 分块上传时，每块的体积
        auto_start: true,                   // 选择文件后自动上传，若关闭需要自己绑定事件触发上传
        init: {
            'FilesAdded': function (up, files) {
                plupload.each(files, function (file) {
                    // 文件添加进队列后，处理相关的事情
                });
            },
            'BeforeUpload': function (up, file) {
                // 每个文件上传前，处理相关的事情
            },
            'UploadProgress': function (up, file) {
                // 每个文件上传时，处理相关的事情
            },
            'FileUploaded': function (up, file, info) {
                // 每个文件上传成功后,处理相关的事情
                // 其中 info.response 是文件上传成功后，服务端返回的json，形式如
                // {
                //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                //    "key": "gogopher.jpg"
                //  }
                let qiniuHeadKey = JSON.parse(info).key;
                let src = up.getOption('domain') + qiniuHeadKey;
                let goods_add_img_edit_container=$("#goods-add-img-edit-container");
                goods_add_img_edit_container.before('<td><img class="layui-upload-img" src="'+src+'"></td>')
                goods_add_img_edit_container.css("display",'none');
                if($("#pic-img img").length<6){
                    goods_add_img_edit_container.css("display",'block');
                }else {
                    layer.msg("商品主图最多6张图片,不可继续增加！！")
                }
                layer.photos({
                    photos: '#pic-img'
                    ,anim: 0
                });
            },
            'Error': function (up, err, errTip) {
                //上传出错时，处理相关的事情
            },
            'UploadComplete': function () {
                //队列文件处理完毕后，处理相关的事情
            },
            'Key': function (up, file) {
                // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                // 该配置必须要在unique_names: false，save_key: false时才生效
                /*   var key = "";
            // do something with key here
            return key*/
            }
        }
    });
    Qiniu.uploader({
        runtimes: 'html5,flash,html4',      // 上传模式，依次退化
        browse_button: 'goods-add-detail-img-edit',         // 上传选择的点选按钮，必需
        // 在初始化时，uptoken，uptoken_url，uptoken_func三个参数中必须有一个被设置
        // 切如果提供了多个，其优先级为uptoken > uptoken_url > uptoken_func
        // 其中uptoken是直接提供上传凭证，uptoken_url是提供了获取上传凭证的地址，如果需要定制获取uptoken的过程则可以设置uptoken_func
        //uptoken : domain+'/upload/getQiniuToken', // uptoken是上传凭证，由其他程序生成
        uptoken_url: domain + '/upload/getQiniuToken',// Ajax请求uptoken的Url，强烈建议设置（服务端提供）
        // uptoken_func: function(){    // 在需要获取uptoken时，该方法会被调用
        //    // do something
        //    return uptoken;
        // },
        get_new_uptoken: false,             // 设置上传文件的时候是否每次都重新获取新的uptoken
        // downtoken_url: '/downtoken',
        // Ajax请求downToken的Url，私有空间时使用，JS-SDK将向该地址POST文件的key和domain，服务端返回的JSON必须包含url字段，url值为该文件的下载地址
        //unique_names: true,              // 默认false，key为文件名。若开启该选项，JS-SDK会为每个文件自动生成key（文件名）
        // save_key: true,                  // 默认false。若在服务端生成uptoken的上传策略中指定了sava_key，则开启，SDK在前端将不对key进行任何处理
        domain: 'http://static.gcc666.top/',     // bucket域名，下载资源时用到，必需
        container: 'goods-add-detail-img-edit-container',             // 上传区域DOM ID，默认是browser_button的父元素
        max_file_size: '100mb',             // 最大文件体积限制
        //flash_swf_url: 'path/of/plupload/Moxie.swf',  //引入flash，相对路径
        max_retries: 3,                     // 上传失败最大重试次数
        dragdrop: true,                     // 开启可拖曳上传
        drop_element: 'goods-add-detail-img-edit-container',          // 拖曳上传区域元素的ID，拖曳文件或文件夹后可触发上传
        chunk_size: '4mb',                  // 分块上传时，每块的体积
        auto_start: true,                   // 选择文件后自动上传，若关闭需要自己绑定事件触发上传
        init: {
            'FilesAdded': function (up, files) {
                plupload.each(files, function (file) {
                    // 文件添加进队列后，处理相关的事情
                });
            },
            'BeforeUpload': function (up, file) {
                // 每个文件上传前，处理相关的事情
            },
            'UploadProgress': function (up, file) {
                // 每个文件上传时，处理相关的事情
            },
            'FileUploaded': function (up, file, info) {
                // 每个文件上传成功后,处理相关的事情
                // 其中 info.response 是文件上传成功后，服务端返回的json，形式如
                // {
                //    "hash": "Fh8xVqod2MQ1mocfI4S4KpRL6D98",
                //    "key": "gogopher.jpg"
                //  }
                let qiniuHeadKey = JSON.parse(info).key;
                let src = up.getOption('domain') + qiniuHeadKey;
                let goods_add_img_edit_container=$("#goods-add-detail-img-edit-container");
                goods_add_img_edit_container.before('<td><img class="layui-upload-img" src="'+src+'"></td>')
                goods_add_img_edit_container.css("display",'none');
                if($("#detail-pic-img img").length<6){
                    goods_add_img_edit_container.css("display",'block');
                }else {
                    layer.msg("商品详情图最多6张图片,不可继续增加！！")
                }
                layer.photos({
                    photos: '#detail-pic-img'
                    ,anim: 0
                });
            },
            'Error': function (up, err, errTip) {
                //上传出错时，处理相关的事情
            },
            'UploadComplete': function () {
                //队列文件处理完毕后，处理相关的事情
            },
            'Key': function (up, file) {
                // 若想在前端对每个文件的key进行个性化处理，可以配置该函数
                // 该配置必须要在unique_names: false，save_key: false时才生效
                /*   var key = "";
            // do something with key here
            return key*/
            }
        }
    });
</script>

</body>
</html>