<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>订单列表</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui/css/layui.css">
</head>
<style>
    .layui-table-cell,.layui-table-page {
        text-align: center;
    }
</style>
<body class="layui-anim layui-anim-scale">
<table class="layui-hide layui-anim layui-anim-scale" id="order_list" lay-filter="table"></table>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="getCheckData">获取选中行数据</button>
        <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">获取选中数目</button>
        <button class="layui-btn layui-btn-sm" lay-event="isAll">验证是否全选</button>
    </div>
</script>

<script type="text/html" id="operation">

    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="to-deliver">去发货</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>


<script src="../../lib/layui/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="../../comm/comm.js"></script>
<script type="text/javascript" src="../js/admin.js"></script>
<script type="text/javascript" src="../../comm/jquery.js"></script>
<script>
    layui.use('table', function(){
        var table = layui.table;
        $(function () {
            $.post(domain+'/user/isLogin', function (res) {
                if(res.code === 102){
                    layer.msg(res.msg, {icon: 5, offset: '20px'}, function () {
                        top.location = '../login.html'
                    })
                }else if(res.code === 200){
                    setTable()
                }else {
                    layer.msg(res.msg);
                }
            });
        });
        function setTable(){
            table.render({
                elem: '#order_list'
                ,url: domain+'/order/list'
                ,method:'post'
                ,contentType:'application/json;charset=UTF-8'
                ,headers:{
                    Accept: '*/*'
                }
                ,parseData: function (res) {
                    let loadIndex=layer.load(2);
                    if(res){
                        layer.close(loadIndex);
                    }
                    let reqs ={
                        code: res.code,
                        msg: res.msg,
                    };
                    if(res.code===200){
                        reqs.count= res.data.count;
                        reqs.data = res.data.orders
                        return reqs;
                    }else {
                        layer.msg(res.msg);
                    }
                }
                ,response: {
                    statusCode: 200 //规定成功的状态码，默认：0
                }
                ,toolbar: '#toolbarDemo' //开启头部工具栏，并为其绑定左侧模板
                ,defaultToolbar: ['filter', 'exports']
                ,title: '订单数据表'
                ,cols: [[
                    {type: 'checkbox', fixed: 'left'}
                    ,{field:'orderId', title:'订单ID', fixed: 'left', unresize: true, sort: true}
                    ,{field:'userNick', title:'购买人', edit: 'text'}
                    ,{field:'goodsName', title:'商品', edit: 'text'}
                    ,{field:'orderPrice', title:'价格', edit: 'text', sort: true}
                    ,{field:'orderDate', title:'日期', sort: true,width: 200}
                    ,{field:'orderStatusStr', title:'状态'}
                    ,{fixed: 'right', title:'操作', toolbar: '#operation',width:200}
                ]]
                ,page: true
                ,loading:false
            });
        }
        //头工具栏事件
        table.on('toolbar(table)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id);
            switch(obj.event){
                case 'getCheckData':
                    var data = checkStatus.data;
                    if(data.length<1){
                        layer.msg('请先选中');
                        break;
                    }
                    layer.alert(JSON.stringify(data));
                    break;
                case 'getCheckLength':
                    var data = checkStatus.data;
                    layer.msg('选中了：'+ data.length + ' 个');
                    break;
                case 'isAll':
                    layer.msg(checkStatus.isAll ? '全选': '未全选');
                    break;
                case 'LAYTABLE_TIPS':
                    layer.alert('这是工具栏右侧自定义的一个图标按钮');
                    break;
            };
        });

        //监听行工具事件
        table.on('tool(table)', function(obj){
            var data = obj.data;
            let orderId = data.orderId;
            if(obj.event === 'del'){
                layer.confirm('删除将不可恢复，确认删除？', function(index){
                    let resq = {
                        orderId:orderId
                    };
                    $.post(domain + '/order/delete',objToJson(resq), function (res) {
                        if (res.code === 200) {
                            layer.msg("删除成功！",{icon:1},function () {
                                obj.del();
                                layer.close(index);
                            });
                        } else if (res.code === 102) {
                            layer.msg(res.msg, {icon: 5, offset: '20px'}, function () {
                                top.location = '../login.html'
                            })
                        } else {
                            layer.msg(res.msg)
                        }
                    });
                });
            } /*else if(obj.event === 'details'){
                xadmin.open('查看和编辑','goods_edit.html',900,500)
            }*/else if(obj.event === 'to-deliver') {
                if(data.orderStatusStr==="已发货"){
                    layer.msg("该商品已发货！")
                }else {
                    setSessionID(orderId);
                    xadmin.open("去发货", 'to-deliver.html',500,450)
                }
            }
        });
    });
</script>

</body>
</html>